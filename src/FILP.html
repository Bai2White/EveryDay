<template>
  <div class="home">
    <section class="declare">
      <div class="top">
        <div class="location" @click="handleRoute('SelectCity')">
          <i class="iconfont icondingweiweizhi"></i>
          [{{areaName}}]
        </div>
      </div>
      <div class="tab">
        <div class="tab-header">
          <div class="tab-title" @click="currentTab='1';" :class="{active:currentTab === '1'}">智能申报</div>
          <div class="tab-title" @click="currentTab='2';" :class="{active:currentTab === '2'}">政策查询</div>
        </div>
        <div class="tab-content">
          <div class="tab-item" v-if="currentTab === '1'">
            <div class="search">
              <input type="text" placeholder="输入企业名称，智能匹配可申报的扶持政策" @click.prevent="handleRoute('project-apply', {type: '1'})" />
              <i class="iconfont iconfangdajing" @click="handleRoute('project-apply', {type: '1'})"></i>
            </div>
          </div>
          <div class="tab-item" v-if="currentTab === '2'">
            <div class="search">
              <input type="text" placeholder="搜索扶持项目，如高新技术企业" @click.prevent="handleRoute('project-apply', {type: '2'})" />
              <i class="iconfont iconfangdajing" @click="handleRoute('project-apply', {type: '2'})"></i>
            </div>
          </div>
        </div>
      </div>
      <div class="bottom">
        <transition-group name="list-complete" tag="div" class="animation-box" v-if="promotions.length">
          <div v-for="item in promotions" :key="item.id" :class="{'amount': item.amount}">
            <div class="company-name">
              <i class="iconfont iconlaba"></i>
              <span>{{item.company}}</span>
            </div>
            <span class="desc" v-if="!item.amount">{{item.typeText}}</span>
            <span class="desc" v-else>
              刚刚匹配到
              <em>{{item.amount}}万+</em>扶持资金
            </span>
          </div>
        </transition-group>
      </div>
    </section>
    <section class="declare">
      <div class="center" v-if="hotPolicy.length">
        <div>
          <h1>热门申报</h1>
          <transition-group name="list-slide-up" tag="div" class="animation-box">
            <a class="declare-item" v-for="item in hotPolicy" :key="item.secretId" @click="handleRoute('Policy', null, {id: item.secretId})">
              <div>
                <span :title="item.name">{{item.name}}</span>
                <span :class="{'hot': item.status == 1}">{{item.statusText}}</span>
              </div>
            </a>
          </transition-group>
        </div>
      </div>
    </section>
    <section class="jump-links">
      <a @click.prevent="handleRoute('Project')">
        <i class="iconfont iconxiangmu"></i>
        项目精选
      </a>
      <a @click.prevent="handleRoute('TagsList', null, {id: '5'})">
        <i class="iconfont icontongzhi"></i>
        申报通知
      </a>
      <a @click.prevent="handleRoute('TagsList', null, {id: '4'})">
        <i class="iconfont icongongshi"></i>
        公示名单
      </a>
      <a @click.prevent="handleRoute('TagsList', null, {id: '6'})">
        <i class="iconfont iconzixun"></i>
        惠企资讯
      </a>
    </section>
    <section>
      <router-link to="/coupons">
        <img style="max-width:100%" src="https://assets.86links.com/86zcy/asset/image/coupon/001.png" alt="抵扣券">
      </router-link>
    </section>
    <section>
      <h1 class="title">
        <span>优惠套餐</span>
        <a @click.prevent="handleRoute('meals')">
          更多
          <i class="iconfont iconyoujiantou"></i>
        </a>
      </h1>
      <div class="meal">
        <a class="card" @click.prevent="handleRoute('meals')">
          <span class="corner"></span>
          企业省心套餐
        </a>
        <a class="card" @click.prevent="handleRoute('meals', {type: '2'})">
          <span class="corner"></span>
          高企认定(入库)套餐
        </a>
      </div>
    </section>
    <section v-if="publicity.length" class="publicity">
      <h1 class="title">
        <span>公示名单</span>
        <a @click.prevent="handleRoute('TagsList', null, {id: '4'})">
          更多
          <i class="iconfont iconyoujiantou"></i>
        </a>
      </h1>
      <div class="box">
        <transition-group name="list-complete" tag="div" class="animation-box" :style="{width: `${publicity.length*100}%`}">
          <a class="item project" v-for="item in publicity" :key="item.secretId" @click.prevent="handleRoute('Policy', null, {id: item.secretId})">
            <h3>
              <span class="article-title" title="item.name">{{item.name}}</span>
              <span class="update">{{item.publishTime | date('%Y-%m-%d')}}</span>
            </h3>
            <div class="tip">
              <div>
                <span class="company-name">{{item.companyName}}</span>
                <span class="company-total">
                  等
                  <em>{{item.count}}</em>家企业已公示
                </span>
              </div>
            </div>
          </a>
        </transition-group>
      </div>
    </section>
    <section v-if="project.length">
      <h1 class="title">
        <span>项目申报</span>
        <a @click.prevent="handleRoute('Project')">
          更多
          <i class="iconfont iconyoujiantou"></i>
        </a>
      </h1>
      <div class="box">
        <a class="item project" v-for="item in project" :key="item.id" @click="handleRoute('Policy', null, {id: item.id})">
          <h3>
            <span class="article-title" :title="item.name">{{item.name}}</span>
          </h3>
          <div class="tags">
            <span v-for="(type, i) in item.types" :key="i">{{type}}</span>
          </div>
        </a>
      </div>
    </section>
    <section v-if="declare.length">
      <h1 class="title">
        <span>申报通知</span>
        <a @click.prevent="handleRoute('TagsList', null, {id: '5'})">
          更多
          <i class="iconfont iconyoujiantou"></i>
        </a>
      </h1>
      <div class="box">
        <a class="item" v-for="item in declare" :key="item.id" @click.prevent="handleRoute('TagsDetail', null, {id: item.id})">
          <h3>
            <span class="article-title" :title="item.title">{{item.title}}</span>
            <span class="update">{{item.publishTime | date('%Y-%m-%d')}}</span>
          </h3>
        </a>
      </div>
    </section>
    <section v-if="information.length">
      <h1 class="title">
        <span>惠企资讯</span>
        <a @click.prevent="handleRoute('TagsList', null, {id: '6'})">
          更多
          <i class="iconfont iconyoujiantou"></i>
        </a>
      </h1>
      <div class="box">
        <a class="item" v-for="item in information" :key="item.id" @click.prevent="handleRoute('TagsDetail', null, {id: item.id})">
          <h3>
            <span class="article-title" :title="item.title">{{item.title}}</span>
            <span class="update">{{item.publishTime | date('%Y-%m-%d')}}</span>
          </h3>
        </a>
      </div>
    </section>
    <footer class="footer">
      <div class="footer-copy">智策云 &copy;2019</div>
      <div class="footer-slogon">基于大数据人工智能的一站式政策专项服务平台</div>
    </footer>
  </div>
</template>

<script>
import { mapState } from 'vuex';
import homeServices from '@/services/home';

export default {
  name: 'home',
  data() {
    return {
      currentTab: '1',
      timerList: [],
      promotions: [],
      declare: [],
      publicity: [],
      information: [],
      project: [],
      hotPolicy: [],
      // location: {
      //   provinceId: '310000',
      //   provinceName: '上海',
      //   cityId: '310100',
      //   cityName: '上海市',
      // },
    };
  },
  watch: {
    areaId() {
      this.getAllData();
    },
  },
  computed: {
    ...mapState(['geoLocation', 'selectedLocation']),
    areaId() {
      return this.selectedLocation.cityId;
    },
    areaName() {
      return this.selectedLocation.cityName;
    },
    mobileDomain() {
      return process.env.VUE_APP_DOMAIN_M;
    },
  },
  methods: {
    handleRoute(name = 'home', query, params) {
      this.$router.push({ name, query, params });
    },
    scrollTimer(list, limit, time = 3000, pushTime = 0) {
      if (list.length <= limit) {
        return;
      }
      window.setInterval(() => {
        const firstItem = list[0];
        list.shift();
        setTimeout(() => {
          list.push(firstItem);
        }, pushTime);
      }, time);
    },
    getPromotions() {
      homeServices.getPromotions().then((res) => {
        this.promotions = res && res.list ? res.list : [];
        this.promotions.forEach((item, i) => {
          this.promotions[i].id = `company${i}`;
        });
        this.scrollTimer(this.promotions, 1, 3000);
      });
    },
    getDeclare() {
      const params = {
        tagId: 5,
        areaId: this.areaId,
        limit: 3,
      };
      homeServices.getDeclare(params).then((res) => {
        this.declare = res && res.length ? res : [];
      });
    },
    getPublicity() {
      const params = {
        cityId: this.areaId,
      };
      homeServices.getPublicity(params).then((res) => {
        this.publicity = res && res.length ? res : [];
        this.scrollTimer(this.publicity, 1, 4000);
      });
    },
    getInformation() {
      const params = {
        limit: 3,
      };
      homeServices.getInformation(params).then((res) => {
        this.information = res && res.length ? res : [];
      });
    },
    getProject() {
      const params = {
        pageNum: 1,
        pageSize: 3,
        region: this.areaId,
      };
      homeServices.getProject(params).then((res) => {
        this.project = res && res.list ? res.list : [];
      });
    },
    getHotPolicy() {
      const params = {
        cityId: this.areaId,
      };
      homeServices.getHotPolicy(params).then((res) => {
        this.hotPolicy = res && res.length ? res : [];
        this.scrollTimer(this.hotPolicy, 3, 3000, 1000);
      });
    },
    getAllData() {
      // 滚动检测新闻
      this.getPromotions();
      // 申报通知
      this.getDeclare();
      // 公示名单
      this.getPublicity();
      // 惠企资讯
      this.getInformation();
      // 项目申报
      this.getProject();
      // 热门申报
      this.getHotPolicy();
    },
  },
  mounted() {
    this.getAllData();
    // 设置title和分享
    this.$wechat.updateShare({
      title: '智策云 - 助您一站式享受政策扶持',
      desc: '智能匹配可申报的政府专项扶持、税收优惠人才补贴！',
    });
  },
};
</script>
<style lang="less" scoped>
.bg() {
  background-position: center center;
  background-size: cover;
  background-repeat: no-repeat;
}
.text-hidden(@w) {
  overflow: hidden;
  max-width: @w;
  text-align: left;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.home {
  min-height: 100vh;
  background: rgba(244, 244, 244, 1);
  padding-bottom: 4.17rem;
  a {
    text-decoration: none;
  }
  section {
    margin-bottom: 0.83rem;
    background: rgba(255, 255, 255, 1);
    &:last-child {
      margin-bottom: 0;
    }
  }
  .title,
  .box {
    padding: 0 1.25rem;
  }
  .title {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin: 0;
    padding-top: 1.25rem;
    padding-bottom: 0.83rem;
    border-bottom: 1px solid rgba(238, 238, 238, 1);
    span {
      position: relative;
      padding-left: 0.5rem;
      color: rgba(0, 0, 0, 1);
      font-weight: 600;
      font-size: 1.5rem;
      font-family: PingFangSC-Semibold;
      &:after {
        position: absolute;
        top: 50%;
        left: 0;
        margin-top: -0.75rem;
        width: 0.17rem;
        height: 1.5rem;
        background: rgba(255, 125, 0, 1);
        content: '';
      }
    }
    a {
      display: inline-flex;
      align-items: center;
      color: rgba(102, 102, 102, 1);
      text-decoration: none;
      font-weight: 500;
      font-size: 1.08rem;
      font-family: PingFang-SC-Medium;
      i {
        margin-top: 2px;
        margin-left: 0.3rem;
        font-size: 0.8rem;
      }
    }
  }
  .item {
    display: block;
    padding: 1.25rem 0;
    border-bottom: 1px solid rgba(238, 238, 238, 1);
    &:last-child {
      border-bottom: 0;
    }
    h3 {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin: 0;
      color: rgba(0, 0, 0, 1);
      font-weight: 500;
      font-size: 1.25rem;
      font-family: PingFang-SC-Medium;
      .article-title {
        color: #666;
        .text-hidden(calc(~'100% - 8rem'));
      }
      .update {
        color: #ccc;
        font-weight: 500;
        font-size: 1rem;
        font-family: PingFang-SC-Medium;
      }
    }
    .tags {
      display: flex;
      flex-wrap: wrap;
      span {
        display: inline-block;
        background: rgba(237, 245, 255, 1);
        border-radius: 0.17rem;
        padding: 0.25rem;
        margin-top: 0.58rem;
        margin-right: 0.67rem;
        color: rgba(153, 153, 153, 1);
        font-weight: 500;
        font-family: PingFang-SC-Medium;
      }
    }
    .tip {
      margin-top: 0.83rem;
      & > div {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      span {
        color: rgba(102, 102, 102, 1);
        font-weight: 500;
        font-size: 1.08rem;
        font-family: PingFang-SC-Medium;
      }
      .company-name {
        .text-hidden(calc(~'100% - 11rem'));
      }
      .company-total em {
        color: #feb23f;
        font-style: normal;
      }
    }
  }
  .publicity {
    .box {
      overflow: hidden;
      max-height: 6.66rem;
      height: 6.66rem;
      padding: 0;
    }
    .animation-box {
      display: flex;
      height: 100%;
      .item {
        padding: 1.25rem;
        width: 100%;
        transition: all 0.3s;
      }
    }
  }
  .project {
    padding: 0.83rem 0;
  }
  .project h3 .article-title {
    .text-hidden(100%);
  }
  .project h3 .update {
    color: rgba(153, 153, 153, 1);
    font-weight: 500;
    font-size: 1rem;
    font-family: PingFang-SC-Medium;
  }
  .meal {
    display: flex;
    justify-content: space-between;
    padding: 1.25rem;
    .card {
      position: relative;
      flex: 1;
      box-sizing: border-box;
      margin-right: 1.5rem;
      padding: 1rem 0.83rem;
      height: 5.83rem;
      border-radius: 0.33rem;
      background: linear-gradient(45deg, rgba(252, 139, 84, 1) 0%, rgba(249, 107, 86, 1) 100%);
      background-image: url('https://assets.86links.com/mzcy/asset/image/home/meal1.png');
      box-shadow: 0rem 0.17rem 0.17rem 0rem rgba(0, 0, 0, 0.04);
      color: rgba(255, 255, 255, 1);
      font-weight: 600;
      font-size: 1.15rem;
      font-family: PingFangSC-Semibold;
      line-height: 1.75rem;

      .bg();
      &:last-child {
        margin-right: 0;
        background: linear-gradient(45deg, rgba(8, 210, 156, 1) 0%, rgba(29, 208, 161, 1) 100%);
        background-image: url('https://assets.86links.com/mzcy/asset/image/home/meal2.png');

        .bg();
        .corner {
          background-image: url('https://assets.86links.com/mzcy/asset/image/home/corner2.png');
        }
      }
      .corner {
        position: absolute;
        top: 0;
        right: 0;
        display: inline-block;
        width: 4.08rem;
        height: 3.83rem;
        background-image: url('https://assets.86links.com/mzcy/asset/image/home/corner1.png');

        .bg();
      }
    }
  }
  .declare {
    .top,
    .center {
      padding: 0 1.25rem;
    }
    .top {
      padding-top: 0.5rem;
      .location {
        display: flex;
        align-items: center;
        color: rgba(255, 125, 0, 1);
        font-weight: 500;
        font-size: 1.17rem;
        font-family: PingFang-SC-Medium;
      }
      .location i {
        margin-right: 0.33rem;
        font-size: 1rem;
      }
    }
    .tab {
      &-header {
        text-align: center;
        height: 3.1rem;
      }
      &-title {
        margin: 0 .9rem;
        display: inline-block;
        font-size: 1.17rem;
        font-weight: 500;
        color: #666666;
        padding: 0.25rem 0.8rem;
        transition: all 0.3s ease;
        border-bottom: 0.17rem solid transparent;
        &.active {
          font-size: 1.33rem;
          color: #ff7d00;
          border-bottom: 0.17rem solid #ff7d00;
        }
      }
    }
    .search {
      position: relative;
      flex: 1;
      margin: 0 1.25rem;
      height: 2.83rem;
    }
    .search input {
      box-sizing: border-box;
      padding: 0 2.4rem 0 0.83rem;
      width: 100%;
      height: 100%;
      outline: none;
      border: 0.08rem solid rgba(238, 238, 238, 1);
      border-radius: 0.33rem;
      background: rgba(242, 241, 240, 1);
      font-weight: 500;
      font-size: 1.08rem;
      font-family: PingFang-SC-Medium;
      line-height: 2.83rem;

      appearance: button;
      &::placeholder {
        color: rgba(153, 153, 153, 1);
        font-weight: 500;
        font-size: 1.08rem;
        font-family: PingFang-SC-Medium;
      }
    }
    .search i {
      position: absolute;
      top: 50%;
      right: 0.83rem;
      color: rgba(174, 174, 174, 1);
      font-size: 1.52rem;
      transform: translateY(-50%);
    }
    .center {
      padding-top: 0.83rem;
      padding-bottom: 0.83rem;
      & > div {
        border-radius: 0.33rem;
        background: rgba(255, 255, 255, 1);
        background-image: url('https://assets.86links.com/mzcy/asset/image/home/declare_bg.png');
        box-shadow: 0rem 0.08rem 0.25rem 0rem rgba(0, 0, 0, 0.1);

        .bg();
        h1 {
          position: relative;
          margin: 0;
          margin-bottom: 1px;
          padding: 0.83rem 0;
          color: rgba(51, 51, 51, 1);
          text-align: center;
          font-weight: 600;
          font-size: 1.5rem;
          font-family: PingFangSC-Semibold;
          &:after {
            position: absolute;
            bottom: -1px;
            left: 0.83rem;
            width: calc(~'100% - 1.66rem');
            height: 1px;
            background: rgba(238, 238, 238, 1);
            content: '';
          }
        }
        .animation-box {
          position: relative;
          overflow: hidden;
          padding-top: 1.08rem;
          max-height: 9.3rem;
        }
        .declare-item {
          display: block;
          margin-bottom: 1.08rem;
          padding: 0 0.83rem;
          & > div {
            display: flex;
            justify-content: space-between;
          }
          span {
            font-weight: 500;
            font-size: 1.17rem;
            font-family: PingFang-SC-Medium;
            &:first-child {
              .text-hidden(calc(~'100% - 8rem'));
            }
            &:last-child {
              color: rgba(72, 135, 252, 1);
            }
          }
          .hot {
            color: rgba(249, 107, 86, 1) !important;
          }
        }
      }
    }
    .bottom {
      padding: 0.83rem 0 1.25rem;
      .btn {
        display: block;
        margin: 0 auto;
        margin-bottom: 1rem;
        width: 10.83rem;
        height: 2.83rem;
        outline: none;
        border: 0;
        border-radius: 0.33rem;
        background: linear-gradient(180deg, rgba(254, 178, 63, 1) 0%, rgba(248, 157, 74, 1) 100%);
        box-shadow: 0rem 0.08rem 0.17rem 0rem rgba(0, 0, 0, 0.2), 0rem 0.17rem 0rem 0rem rgba(211, 105, 2, 1);
        color: rgba(255, 255, 255, 1);
        text-align: center;
        font-weight: 600;
        font-size: 1.25rem;
        font-family: PingFangSC-Semibold;
        line-height: 2.83rem;
      }
      .animation-box {
        overflow: hidden;
        padding: 0 1.25rem;
        max-height: 1.41rem;
        color: rgba(51, 51, 51, 1);
        font-weight: 500;
        font-size: 1rem;
        font-family: PingFang-SC-Medium;
        & > div {
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 1s;
        }
        .company-name {
          display: flex;
          align-items: center;
          margin-right: 2.75rem;
          max-width: calc(~'100% - 11.75rem');
          i {
            margin-right: 0.83rem;
            color: rgba(255, 125, 0, 1);
            font-size: 1.3rem;
          }
          span {
            display: inline-block;

            .text-hidden(calc(~'100% - 2.13rem'));
          }
        }
        .desc em {
          color: #feb23f;
          font-style: normal;
        }
      }
      .amount .company-name {
        max-width: calc(~'100% - 16rem');
        span {
          .text-hidden(calc(~'100% - 2.13rem'));
        }
      }
      p {
        margin: 0;
        margin-top: 1rem;
        color: rgba(153, 153, 153, 1);
        text-align: center;
        font-weight: 500;
        font-size: 1.17rem;
        font-family: PingFang-SC-Medium;
      }
    }
  }
  .jump-links {
    display: flex;
    justify-content: space-around;
    padding: 0.83rem 1.25rem;
    a {
      display: flex;
      align-items: center;
      flex-direction: column;
      color: rgba(51, 51, 51, 1);
      font-weight: 500;
      font-size: 1.08rem;
      font-family: PingFang-SC-Medium;
      i {
        margin-bottom: 0.42rem;
        color: rgba(44, 170, 246, 1);
        font-size: 2.17rem;
      }
      &:nth-child(2) i {
        color: rgba(254, 135, 18, 1);
      }
      &:nth-child(3) i {
        color: rgba(76, 170, 66, 1);
      }
      &:nth-child(4) i {
        color: rgba(250, 192, 29, 1);
      }
    }
  }
}
.list-slide-up-enter {
  transition: all 0s ease-out;
}
.list-slide-up-move {
  transition: transform 0.8s ease-out;
}
.list-slide-up-leave-to {
  opacity: 0;
  transform: translate3d(0, -100%, 0);
}
.list-slide-up-leave-active {
  position: absolute;
  left: 0;
  width: 100%;
  transition: all 0.8s ease-out;
}

.footer {
  font-size: 0.83rem;
  text-align: center;
  color: #999999;
  padding-bottom: 0.5rem;
  div {
    line-height: 1.2rem;
  }
}
</style>
